package org.bheaver.ngl4.cataloguing.services.importCatalogue

import com.typesafe.scalalogging.Logger
import org.bheaver.ngl4.cataloguing.AsyncUnitTestBase
import org.bheaver.ngl4.cataloguing.exceptions.BadMARCRecordException
import org.bheaver.ngl4.cataloguing.model.importCatalogueModel._
import org.bheaver.ngl4.util.exceptions.BadRequestException

class ParseCatalogueRecordTest extends AsyncUnitTestBase {
  val logger = Logger(classOf[ParseCatalogueRecordTest])

  behavior of "ParseCatalogueRecord"

  it should "Throw BadRequestException when isoRecord is empty" in {
    val parseCatalogueRecord: ParseCatalogueRecord = new ParseCatalogueRecordImpl
    recoverToSucceededIf[BadRequestException](parseCatalogueRecord.parse(ParseRequest("", null)))
  }
  it should "Throw BadMARCRecordException when record is not in a proper format" in {
    val parseCatalogueRecord: ParseCatalogueRecord = new ParseCatalogueRecordImpl
    recoverToSucceededIf[BadMARCRecordException](parseCatalogueRecord.parse(ParseRequest("SOME JUNK NON ISO", null)))
  }
  it should "be able to parse iso record and return the MARC record" in {
    val marcString = "02817cam a2200445 i 45000010009000000050017000090080041000269060045000679250042001129550057001540100017002110150021002280160025002490200018002740200015002920350024003070400155003310420008004860430012004940500028005060550026005340820016005601000036005762450079006122500019006912640053007102640011007633000034007743360026008083370028008343380027008625201064008896000052019536000047020056500046020526500050020987000068021487760114022169230041023302115199720190907092923.0190826t20162016oncc          000 d eng d  a0bibcccopycatd3encipf20gy-gencatlg0 aacquireb1 shelf copyxpolicy default  bhc15 2019-08-26 z-processorihc15 2019-09-07 to BCCD  a  2019410095  a201690657902can  a(AMICUS)000044795429  a9781770915725  a1770915729  a(OCoLC)ocn957649660  aTOHbengcTOHerdadBTCTAdNLCdOCLCQdCUIdOCLCOdIQUdYDXdOCLCQdOCLCFdISMdOCLCAdBDXdCNEDMdCDNdCNCARdOCLCQdUABdOCLdHLSdCNMTRdCDNSBdDLC  apcc  an-cn-bc00aPR9199.4.K363bI53 2016 3aPS8621 A486bI53 201604aC812/.62231 aKanagawa, Hiro,d1963-eauthor.10aIndian Arm /cby Hiro Kanagawa ; adapted from Henrik Ibsen's Little Eyolf.  aFirst edition. 1aToronto, ON :bPlaywrights Canada Press,c[2016] 4cÂ©2016  a97 pages ;bportrait ;c22 cm  atextbtxt2rdacontent  aunmediatedbn2rdamedia  avolumebnc2rdacarrier  a\"Rita and Alfred Allmers live in an isolated family cabin on native leasehold land overlooking Indian Arm, a still untamed glacial fjord just north of Vancouver, BC. With Alfred--a formerly promising novelist--now struggling with his latest work, Rita has been tasked with caring for their adopted son Wolfie, a sensitive First Nations teen who has been designated as \"special needs\" for much of his life. Rita's resentments and frustrations are further embittered by her younger half-sister, Asta, a constant reminder of the innocence, idealism, and sexual allure Rita once had and yearns for again. The fragile impasse of their lives is torn asunder by the appearance of Janice, the surviving member of the Indigenous family who leased the land to Rita and Asta's reclusive and mysterious father over fifty years ago. With the lease now expired, they are all engulfed by the secrets and contradictions of their lives and of the land itself--in both the past and the present--and their stories are drawn inexorably toward an unspeakable tragedy.\"--Amazon.ca.10aIbsen, Henrik,d1828-1906.tLille EyolfvDrama.14aIbsen, Henrik,cLittle EyolfvAdaptations. 0aIndian children with disabilitiesvDrama. 5aDramatists, Canadian (English)y20th century.1 aIbsen, Henrik,d1828-1906.tLille Eyolf.iAdaptation of (work):1 aKanagawa, Hiro, 1963-, author.tIndian arm./dToronto : Playwright's Canada Press, 2016.w(CaOONL)20169065804  aPurchased2019-08-26nI-112969sGOBI"
    val parseCatalogueRecord: ParseCatalogueRecord = new ParseCatalogueRecordImpl
    parseCatalogueRecord.parse(ParseRequest(marcString,""))
      .map(record => {
        val records = record.records
        assert(records.size==1)
        assert(records.head.getDatafieldsByTag("245").head.getSubfieldsByIdentifier("a").head.data.equals("Indian Arm /"))
      })
  }
  it should "be able to parse multiple isorecords separated by record delimiter" in {
    val multiMarcString = "02209cam a2200373 i 45000010009000000050017000090080041000269060045000679250042001129550134001540100017002880200030003050200030003350200026003650400028003910420008004190500021004270820012004482450070004602460049005302640045005793000045006243360026006693370028006953380027007234900025007505040061007755050634008365210019014706500062014897000031015517760135015829630118017171949184920180102102846.0170213s2018    mnua     b    001 0 eng    a7bcbccorignewd1eecipf20gy-gencatlg0 aacquireb1 shelf copyxpolicy default  bxk16 2017-02-13ixk16 2017-02-13wxk16 2017-02-13axn11 2017-11-30 1 copy rec'd., to CIP ver.fxk25 2017-01-02 (telework) to CALM  a  2016047450  a9781632354143 (hardcover)  a9781632354853 (softcover)  z9781621435372 (ebook)  aDLCbengcDLCerdadDLC  apcc00aPS662b.A13 201800a81522304aThe 12 most influential speeches of all time /cby Marne Ventura.3 aTwelve most influential speeches of all time 1aMankato, MN :b12 Story Library,c[2018]  a32 pages :bcolor illustrations ;c24 cm  atextbtxt2rdacontent  aunmediatedbn2rdamedia  avolumebnc2rdacarrier0 aThe most influential  aIncludes bibliographical references (page 31) and index.0 aSpeech to the troops at Tilbury / by Elizabeth I -- Give me liberty or give me death / by Patrick Henry -- Ain't I a woman? / by Sojourner Truth -- What to the slave is the Fourth of July / by Frederick Douglass -- The Gettysburg Address / by Abraham Lincoln -- Women's rights to the suffrage / by Susan B. Anthony -- Surrender speech / by Chief Joseph -- Do or die / by Mahatma Gandhi -- Inauguration Address / by John F. Kennedy -- We shall overcome / by Lyndon B. Johnson -- Stanford commencement address / by Steve Jobs -- Worldwide access to education / by Malala Yousafzai -- Other notable influential speeches -- glossary.2 aGrades 4 to 6. 0aSpeeches, addresses, etc., AmericanvJuvenile literature.1 aVentura, Marne,eSelector.08iOnline version:t12 most influential speeches of all timedMankato, MN : 12 Story Library, [2018]z9781621435372w(DLC) 2017007010  aSusanne Bushman; phone: 952-7467867 x 268; email: s.bushman@redlineeditorial.com; bc: m.tupy@redlineeditorial.com01799cam a22003498i 45000010009000000050017000090080041000269060045000679250042001129550097001540100017002510200030002680400023002980420008003210500024003290820016003532450475003692500019008442630009008632640038008723000013009103360026009233370028009493380027009775040051010046500028010557000051010837000027011347000035011617760151011969630102013472049142820180614181122.0180510s2019    nju      b    001 0 eng    a7bcbccorignewd1eecipf20gy-gencatlg0 aacquireb1 shelf copyxpolicy default  brk14 2018-05-10crk14 2018-05-10 telework to subjdrl12 2018-06-14 to Deweywxm06 2018-06-14  a  2018022528  a9781119128618 (hardcover)  aDLCbengerdacDLC  apcc00aTK7867.8b.A38 201900a621.38122300aAdvanced materials for electromagnetic shielding :bfundamentals, properties, and applications /cedited by Maciej Wladyslaw Jaroszewski, Wroclaw University of Science and Technology, Faculty of Electrical Engineering, Wroclaw, Poland, Sabu Thomas, Mahatma Gandhi University, Priyadarshini Hills, Kottayam, Kerala, Ajay V. Rane, Composite Research Group, Durban University of Technology, South Africa and Mahatma Gandhi University, Priyadarshini Hills, Kottayam, Kerala.  aFirst edition.  a1811 1aHoboken, NJ, USA :bWiley,c2019.  apages cm  atextbtxt2rdacontent  aunmediatedbn2rdamedia  avolumebnc2rdacarrier  aIncludes bibliographical references and index. 0aShielding (Electricity)1 aJaroszewski, Maciej Wladyslaw,d1966-eeditor.1 aThomas, Sabu,eeditor.1 aRane, Ajay V.,d1987-eeditor.08iOnline version:tAdvanced materials for electromagnetic shieldingbFirst edition.dHoboken, NJ, USA : Wiley, 2019z9781119128649w(DLC) 2018028981  aJerusha Govindakrishnan; phone: +91-44 43950500; email: jgovindakr@wiley.com; bc: ccopy@wiley.com"
    val parseCatalogueRecord: ParseCatalogueRecord = new ParseCatalogueRecordImpl
    parseCatalogueRecord.parse(ParseRequest(multiMarcString,""))
      .map(record => {
        val records = record.records
        assert(records.size==2)
      })
  }
}
